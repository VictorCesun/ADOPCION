{% extends 'adopcion_perros/base.html' %}
{% load static %}

{% block title %}Formulario de Adopción - Huellitas{% endblock %}

{% block content %}
<main class="main-content">
  <h2 class="form-title">Formulario de Adopción</h2>

  <form id="adopcionForm" class="adoption-form">
    {% csrf_token %}

    <label for="nombre_completo">Nombre completo:</label>
    <input type="text" name="nombre_completo" id="nombre_completo" required minlength="5" maxlength="100">

    <label for="email">Email:</label>
    <input type="email" name="email" id="email" required>

    <label for="telefono">Teléfono:</label>
    <input type="tel" name="telefono" id="telefono" required pattern="[0-9]{10}" title="Debe tener 10 dígitos numéricos">

    <label for="id_perro">Mascota a adoptar:</label>
    <select name="id_perro" id="id_perro" required>
      <option value="">Selecciona una mascota</option>
      {% for perro in perros %}
        <option value="{{ perro.id }}">{{ perro.nombre }}</option>
      {% endfor %}
    </select>

    <label for="mensaje">Mensaje:</label>
    <textarea name="mensaje" id="mensaje" required minlength="10" maxlength="500"></textarea>

    <button type="submit" class="btn-submit">Enviar solicitud</button>
  </form>

  <div id="mensajeExito" class="success-message" style="display:none;">
    ¡Solicitud enviada correctamente!
  </div>
</main>

<script>
document.getElementById("adopcionForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  const form = this;

  const nombre = form.nombre_completo.value.trim();
  const email = form.email.value.trim();
  const telefono = form.telefono.value.trim();
  const mensaje = form.mensaje.value.trim();
  const perro = form.id_perro.value;

  if (nombre.length < 5) {
    alert("El nombre debe tener al menos 5 caracteres.");
    return;
  }

  if (!email.includes("@")) {
    alert("Ingresa un correo válido.");
    return;
  }

  if (!/^\d{10}$/.test(telefono)) {
    alert("El teléfono debe tener 10 dígitos numéricos.");
    return;
  }

  if (!perro) {
    alert("Debes seleccionar una mascota.");
    return;
  }

  if (mensaje.length < 10) {
    alert("El mensaje debe tener al menos 10 caracteres.");
    return;
  }

  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  const response = await fetch("{% url 'api_adopciones' %}", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": csrftoken
    },
    body: JSON.stringify(data)
  });

  if (response.ok) {
    alert("¡Solicitud enviada correctamente!");
    form.reset();
  } else {
    const error = await response.json();
    alert("Error al enviar la solicitud: " + JSON.stringify(error));
  }
});
</script>
{% endblock %}
